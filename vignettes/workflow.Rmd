---
title: "PhantomPurgeR: Vignette"
author: "Rick Farouni"
package: PhantomPurgeR
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{PhantomPurgeR Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r, echo=FALSE, results="hide", message=FALSE}
require(knitr)
opts_chunk$set(error=FALSE, message=FALSE, warning=FALSE)
```
```{r}
library(PhantomPurgeR)
```



### Read filepaths of all h5 files found in input_dir

```{r}
input_dir <- system.file("extdata", package = "PhantomPurgeR")
```

```{r}
samples <- get_h5_filenames(input_dir)
```

Change the names of the samples if needed

```{r}
names(samples) <- paste0("s", 1:length(samples))
samples
```

# Run PhantomPurgeR workflow

## (1) Read data

```{r}
out <- read10xMolInfoSamples(samples, barcode_length = NULL)
```

##  (2) Join and merge data

```{r}
out <- join_data(out)
```

### Read counts datatable

```{r}
out$read_counts
```


## (3) Estimate sample index hopping rate

```{r}
out <- estimate_hopping_rate(out, max_r = NULL)
```

### Estimates

```{r}
out$glm_estimates
```


#### Summary statistics of the joined read counts datatable

```{r}
out$summary_stats$summary_estimates
```

p_chimeras is the proportion CUGs that are chimeric. g is the estimated proportion of fugue molecules and u is the molecule inflation factor such that n_cugs x u would give the number of non-fugue phantom molecules. The estimated total number of phantom molecules present in the dataset is given by n_pm=n_cugs x (u+g).


#### Marginal summary statistics

```{r}
out$summary_stats$marginal
```

## (4) Purge phantom molecules

Set the trade-off ratio cost cutoff (torc). The parameter torc represents the number of real molecules one is willing to incorrectly discard in order to correctly purge one phantom molecule. Since discarding a large proportion of the data is undesirable, reasonable values of torc are expected to be within the range of 1-5.

```{r}
out <- purge_phantoms(out,
                      torc=3,
                      return_readcounts=FALSE,
                      return_discarded=TRUE)
```



```{r}
out$summary_stats$cutoff_dt
```

The row discard_torc shows the outcome whose qr value is the maximum allowed. Reads corresponding to outcomes with greater qr values are discarded. no_discarding corresponds to retaining all reassigned reads and no_purging corresponds to keeping the data as it is.

```{r}
out$summary_stats$purge_summary
```


```{r}
str(out$umi_counts$retained)
```

```{r}
str(out$umi_counts$discarded)
```



#### Outcome counts datatable

The datatable is ordered in descending order of qr, the posterior probability of incorrectly assigning s as the inferred sample of origin. n is the number of CUGs with the corresponding outcome and p_outcome is the observed marginal probability of that outcome.

```{r}
out$outcome_counts
```


Alternatively all the preceding 4 steps can all be run at once.

```{r}
#out <- phantom_purger(samples, torc=3, max_r = NULL, barcode_length=NULL, return_readcounts=FALSE, return_discarded=TRUE)
```


## Make plots

```{r message=FALSE, warning=FALSE}
dataset_name <- "testdata"
plots <- make_plots(out, dataset_name, x_lim = 60, legend_rel_width=0.2)
```


```{r fig.width=14, message=FALSE, warning=FALSE}
plots 
```

```{r}
sessionInfo()
```


