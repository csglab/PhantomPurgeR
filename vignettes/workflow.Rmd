---
title: "PhantomPurgeR: Vignette"
author: "Rick Farouni"
package: PhantomPurgeR
date: "`r Sys.Date()`"
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{PhantomPurgeR Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r, echo=FALSE, results="hide", message=FALSE}
require(knitr)
opts_chunk$set(error=FALSE, message=FALSE, warning=FALSE)
```
```{r}
library(PhantomPurgeR)
```



### Read filepaths of all h5 files found in the data input folder

The data directory *input_dir* is the filepath of the folder that contains all the molecule_info.h5 files of all the samples that were multiplexed on the same lane. The files can be renamed by sample names (e.g. sample_name.h5) before being loaded or after as shown below. 

```{r}
input_dir <- "~/Documents/hiseq4000"
```

```{r}
samples_filepaths <- get_h5_filenames(input_dir)
samples_filepaths
```

Change the names of the samples if the filenames are too long.

```{r}
#names(samples_filepaths) <- paste0("s", 1:length(samples_filepaths))
```

# Run PhantomPurgeR workflow

The workflow can be run in four stages or alternatively all steps can all be run at once using the *phantom_purger* function.

```{r}
#out <- phantom_purger(samples, torc=3, return_readcounts=FALSE, return_discarded=FALSE)
```


## (1) Read data

```{r}
out <- read10xMolInfoSamples(samples_filepaths)
```

##  (2) Join and merge data

```{r}
out <- join_data(out)
```

### Read counts datatable

```{r}
out$read_counts
```


## (3) Estimate sample index hopping rate

```{r}
out <- estimate_hopping_rate(out)
```

### Estimates

```{r}
out$glm_estimates
```


#### Summary statistics of the joined read counts datatable

```{r}
out$summary_stats$summary_estimates
```

p_chimeras is the proportion CUGs that are chimeric. g is the estimated proportion of fugue molecules and u is the molecule inflation factor such that n_cugs x u would give the number of non-fugue phantom molecules. The estimated total number of phantom molecules present in the dataset is given by n_pm=n_cugs x (u+g).


#### Marginal summary statistics

```{r}
out$summary_stats$marginal
```

## (4) Purge phantom molecules

Call garbage collection first

```{r}
gc()
```

Set the trade-off ratio cost cutoff (torc). The parameter torc represents the number of real molecules one is willing to incorrectly discard in order to correctly purge one phantom molecule. Since discarding a large proportion of the data is undesirable, reasonable values of torc are expected to be within the range of 1-5.

```{r}
out <- purge_phantoms(out,
                      torc=3,
                      return_readcounts=FALSE,
                      return_discarded=FALSE)
```



```{r}
out$summary_stats$cutoff_dt
```

The row discard_torc shows the outcome whose qr value is the maximum allowed. Reads corresponding to outcomes with greater qr values are discarded. no_discarding corresponds to retaining all reassigned reads and no_purging corresponds to keeping the data as it is.

```{r}
out$summary_stats$purge_summary
```


```{r}
str(out$umi_counts$retained$A1)
```




#### Outcome counts datatable

The datatable is ordered in descending order of qr, the posterior probability of incorrectly assigning s as the inferred sample of origin. n is the number of CUGs with the corresponding outcome and p_outcome is the observed marginal probability of that outcome.

```{r}
out$outcome_counts
```




## Make diagnostic plots

```{r message=FALSE, warning=FALSE}
dataset_name <- "Hiseq4000"
plots <- make_plots(out, dataset_name, x_lim = 150, legend_rel_width=0.2)
```


```{r fig.width=12, message=FALSE, warning=FALSE}
plots 
```

```{r}
sessionInfo()
```


